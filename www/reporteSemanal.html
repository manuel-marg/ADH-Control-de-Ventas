<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
  <style>
    body { font-family: Arial, sans-serif; }
    .container { padding: 20px; }
    h2 { color: #4285f4; border-bottom: 1px solid #eee; padding-bottom: 5px; }
    .category-block { margin-top: 30px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; table-layout: fixed; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; word-wrap: break-word; }
    th { background-color: #f2f2f2; }
    .total-row { font-weight: bold; background-color: #f2f2f2; }
    .total-col { font-weight: bold; }
    .grand-total { font-weight: bold; background-color: #e8e8e8; }
    .category-header {
      background-color: #8ab4d7;
      text-align: center;
      font-weight: bold;
      text-transform: uppercase;
      font-size: 1.1em;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Reporte Semanal de Ventas</h2>
    <p><strong>Período:</strong> <?= fechas.inicio_str ?> - <?= fechas.fin_str ?></p>

    <!-- Botón de Exportar -->
    <div style="text-align: right; margin-bottom: 20px;">
      <button id="export-btn" class="action" onclick="exportarPDF()">Exportar a PDF</button>
      <div id="loading-pdf" style="display: none; margin-top: 10px;">Generando PDF...</div>
    </div>

    <? if (Object.keys(reporteData).length === 0) { ?>
      <p>No hay datos de ventas para el período seleccionado.</p>
    <? } else { ?>
      <? for (var categoria in reporteData) { ?>
        <div class="category-block">
          <table>
            <thead>
              <tr>
                <th colspan="<?= reporteData[categoria].metodosDePago.length + 1 ?>" class="category-header"><?= categoria ?></th>
              </tr>
              <tr>
                <th style="background-color: #fcd5b4; font-weight: bold;">Día de la Semana</th>
                <? for (var i = 0; i < reporteData[categoria].metodosDePago.length; i++) { var metodo = reporteData[categoria].metodosDePago[i]; ?>
                  <th style="background-color: #fcd5b4; font-weight: bold;"><?= metodo ?></th>
                <? } ?>
              </tr>
            </thead>
            <tbody>
              <? for (var dia in reporteData[categoria].dias) { ?>
                <tr>
                  <td class="total-col"><?= dia ?></td>
                  <? for (var i = 0; i < reporteData[categoria].metodosDePago.length; i++) { var metodo = reporteData[categoria].metodosDePago[i]; ?>
                    <? if (metodo.includes('Bs') || metodo.includes('Punto de venta') || metodo.includes('Pago Movil') || metodo.includes('Efectivo en Bs.')) { ?>
                      <td><?= (reporteData[categoria].dias[dia][metodo] || 0).toFixed(2) ?> Bs.</td>
                    <? } else { ?>
                      <td>$<?= (reporteData[categoria].dias[dia][metodo] || 0).toFixed(2) ?></td>
                    <? } ?>
                  <? } ?>
                </tr>
              <? } ?>
            </tbody>
            <tfoot>
              <tr class="total-row">
                <td class="grand-total">Total por Método</td>
                <? for (var i = 0; i < reporteData[categoria].metodosDePago.length; i++) { var metodo = reporteData[categoria].metodosDePago[i]; ?>
                  <? if (metodo.includes('Bs') || metodo.includes('Punto de venta') || metodo.includes('Pago Movil') || metodo.includes('Efectivo en Bs.')) { ?>
                    <td class="grand-total"><?= reporteData[categoria].totalesPorMetodo[metodo].toFixed(2) ?> Bs.</td>
                  <? } else { ?>
                    <td class="grand-total">$<?= reporteData[categoria].totalesPorMetodo[metodo].toFixed(2) ?></td>
                  <? } ?>
                <? } ?>
              </tr>
            </tfoot>
          </table>
        </div>
      <? } ?>

      <!-- Grand Total Summary Table -->
      <div class="category-block">
        <h3>Resumen General de Métodos de Pago</h3>
        <table style="width: 50%; margin-left: auto; margin-right: auto;">
          <thead>
            <tr>
              <th style="background-color: #8ab4d7; font-weight: bold;">Método de Pago</th>
              <th style="background-color: #8ab4d7; font-weight: bold;">Monto Total</th>
            </tr>
          </thead>
          <tbody>
            <? for (var i = 0; i < metodosOrdenados.length; i++) { var metodo = metodosOrdenados[i]; ?>
              <tr>
                <td class="total-col"><?= metodo ?></td>
                <? if (metodo.includes('Bs') || metodo.includes('Punto de venta') || metodo.includes('Pago Movil') || metodo.includes('Efectivo en Bs.')) { ?>
                  <td><?= (totalesGeneralesPorMetodo[metodo] || 0).toFixed(2) ?> Bs.</td>
                <? } else { ?>
                  <td>$<?= (totalesGeneralesPorMetodo[metodo] || 0).toFixed(2) ?></td>
                <? } ?>
              </tr>
            <? } ?>
          </tbody>
        </table>
      </div>

      <!-- Totals by Currency Table -->
      <div class="category-block">
        <h3>Resumen General por Moneda</h3>
        <table style="width: 50%; margin-left: auto; margin-right: auto;">
          <thead>
            <tr>
              <th style="background-color: #8ab4d7; font-weight: bold;">Moneda</th>
              <th style="background-color: #8ab4d7; font-weight: bold;">Monto Total</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="total-col">Dólares (USD)</td>
              <td>$<?= (totalesPorMoneda.USD || 0).toFixed(2) ?></td>
            </tr>
            <tr>
              <td class="total-col">Bolívares (Bs)</td>
              <td><?= (totalesPorMoneda.BS || 0).toFixed(2) ?> Bs.</td>
            </tr>
          </tbody>
        </table>
      </div>
    <? } ?>
  </div>

  <script>
    function exportarPDF() {
      document.getElementById('export-btn').style.display = 'none';
      document.getElementById('loading-pdf').style.display = 'block';

      const fechas = { 
        inicio: '<?= fechas.inicio_raw ?>', 
        fin: '<?= fechas.fin_raw ?>'
      };

      google.script.run
        .withSuccessHandler(function(url) {
          document.getElementById('loading-pdf').innerHTML = '<a href="' + url + '" target="_blank">PDF Generado. Haz clic para abrir.</a>';
        })
        .withFailureHandler(function(error) {
          document.getElementById('loading-pdf').innerHTML = 'Error: ' + error.message;
        })
        .exportarReporteSemanalAPdf(fechas);
    }
  </script>
</body>
</html>
